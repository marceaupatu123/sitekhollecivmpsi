<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site de la Classe de MPSI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script>
        function refreshPage() {
            setTimeout(function() {
                window.location.reload();
            }, 2000); // Rafraîchit la page après 2 secondes
        }
    </script>
</head>
<body>
    <header>
        <h1>Site de la Classe de MPSI</h1>
        {% if current_user.is_authenticated %}
            <a href="{{ url_for('logout') }}">Se déconnecter</a>
        {% else %}
            <a href="{{ url_for('login') }}">Se connecter</a> | 
            <a href="{{ url_for('register') }}">S'inscrire</a>
        {% endif %}
    </header>
    <div class="content">
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                <div class="flash-message">
                    {{ messages[0] }}
                </div>
                <script>
                    refreshPage();
                </script>
            {% endif %}
        {% endwith %}
        {% if current_user.is_authenticated %}
        <div class="card">
            <h2>Déposer un énoncé de khôlle</h2>
            <div id="error-message" style="color: red;"></div>
            <form action="/upload" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="subject">Matière:</label>
                    <select id="subject" name="subject" required>
                        <option value="" disabled selected>Choisissez votre matière</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="chapter">Chapitre:</label>
                    <select id="chapter" name="chapter" required></select>
                </div>
                <div class="form-group">
                    <label for="kholleur">Khôlleur:</label>
                    <select id="kholleur" name="kholleur" required>
                        <option value="" disabled selected>Choisissez votre khôlleur</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="difficulty">Difficulté:</label>
                    <div class="star-rating">
                        <input type="radio" id="star5" name="difficulty" value="5" required><label for="star5" title="5 étoiles">★</label>
                        <input type="radio" id="star4" name="difficulty" value="4"><label for="star4" title="4 étoiles">★</label>
                        <input type="radio" id="star3" name="difficulty" value="3"><label for="star3" title="3 étoiles">★</label>
                        <input type="radio" id="star2" name="difficulty" value="2"><label for="star2" title="2 étoiles">★</label>
                        <input type="radio" id="star1" name="difficulty" value="1"><label for="star1" title="1 étoile">★</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="file">Fichier:</label>
                    <input type="file" name="file" id="file" accept="image/*" required>
                </div>
                <div class="form-group">
                    <button type="submit">Déposer</button>
                </div>
            </form>
        </div>
        {% else %}
        <div class="alert">
            <p>Veuillez vous <a href="{{ url_for('login') }}">connecter</a> ou vous <a href="{{ url_for('register') }}">inscrire</a> pour déposer un énoncé de khôlle.</p>
        </div>
        {% endif %}
    </div>
 
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const errorMessage = document.getElementById('error-message');

            fetch('/get_structure')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const subjectSelect = document.getElementById('subject');
                    const chapterSelect = document.getElementById('chapter');

                    for (const subject in data) {
                        const option = document.createElement('option');
                        option.value = subject;
                        option.textContent = subject;
                        subjectSelect.appendChild(option);
                    }

                    subjectSelect.addEventListener('change', function() {
                        chapterSelect.innerHTML = '';
                        const chapters = data[this.value];

                        if (chapters) {
                            chapters.forEach(chapter => {
                                const option = document.createElement('option');
                                option.value = chapter;
                                option.textContent = chapter;
                                chapterSelect.appendChild(option);
                            });
                        }
                    });
                })
                .catch(error => {
                    errorMessage.textContent = 'There was a problem with the fetch operation: ' + error.message;
                });

            fetch('/get_kholleurs')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const kholleurSelect = document.getElementById('kholleur');
                    for (const subject in data) {
                        const group = document.createElement('optgroup');
                        group.label = subject;
                        data[subject].forEach(kholleur => {
                            const option = document.createElement('option');
                            option.value = kholleur;
                            option.textContent = kholleur;
                            group.appendChild(option);
                        });
                        kholleurSelect.appendChild(group);
                    }
                })
                .catch(error => {
                    errorMessage.textContent = 'There was a problem with the fetch operation: ' + error.message;
                });
        });
    </script>

<!-- Add this at the bottom of the body tag -->
<div class="submissions">
    <h2>Les Énoncés de Khôlle Publiés</h2>
    <div class="filters">
        <label for="filter-subject">Filtrer par matière:</label>
        <select id="filter-subject">
            <option value="">Toutes les matières</option>
        </select>
        <label for="filter-chapter">Filtrer par chapitre:</label>
        <select id="filter-chapter">
            <option value="">Tous les chapitres</option>
        </select>
        <button id="apply-filters">Appliquer les filtres</button>
    </div>
    <div id="submissions-list"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const submissionsList = document.getElementById('submissions-list');
        const filterSubject = document.getElementById('filter-subject');
        const filterChapter = document.getElementById('filter-chapter');
        const applyFiltersButton = document.getElementById('apply-filters');

        function fetchSubmissions(subject = '', chapter = '') {
            let url = '/get_submissions';
            if (subject || chapter) {
                url += `?subject=${subject}&chapter=${chapter}`;
            }

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    submissionsList.innerHTML = '';
                    data.forEach(submission => {
                        const submissionDiv = document.createElement('div');
                        submissionDiv.classList.add('submission');
                        submissionDiv.innerHTML = `
                            <p><strong>Prénom:</strong> ${submission.prenom}</p>
                            <p><strong>Matière:</strong> ${submission.subject}</p>
                            <p><strong>Chapitre:</strong> ${submission.chapter}</p>
                            <p><strong>Khôlleur:</strong> ${submission.kholleur}</p>
                            <p><strong>Date:</strong> ${submission.date}</p>
                            <div class="star-rating">
                                ${[...Array(5)].map((_, i) => `
                                    <input type="radio" id="star${i+1}-${submission.id}" name="rating-${submission.id}" value="${i+1}" ${i+1 == submission.difficulte ? 'checked' : ''} disabled>
                                    <label for="star${i+1}-${submission.id}">&#9733;</label>
                                `).join('')}
                            </div>
                            <img src="${submission.image_url}" alt="Image de l'énoncé">
                        `;
                        submissionsList.appendChild(submissionDiv);
                    });
                })
                .catch(error => {
                    submissionsList.innerHTML = 'There was a problem with the fetch operation: ' + error.message;
                });
        }

        applyFiltersButton.addEventListener('click', function() {
            const subject = filterSubject.value;
            const chapter = filterChapter.value;
            fetchSubmissions(subject, chapter);
        });

        // Populate filter options
        fetch('/get_structure')
            .then(response => response.json())
            .then(data => {
                for (const subject in data) {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    filterSubject.appendChild(option);
                }

                filterSubject.addEventListener('change', function() {
                    filterChapter.innerHTML = '<option value="">Tous les chapitres</option>';
                    const chapters = data[this.value];
                    if (chapters) {
                        chapters.forEach(chapter => {
                            const option = document.createElement('option');
                            option.value = chapter;
                            option.textContent = chapter;
                            filterChapter.appendChild(option);
                        });
                    }
                });
            });

        // Initial fetch of submissions
        fetchSubmissions();
    });
</script>
</body>
</html>